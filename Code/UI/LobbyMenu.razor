@using System;
@using Sandbox;
@using Sandbox.UI;
@using Sandbox.Network;
@inherits PanelComponent
@namespace Sandbox

<root>

	<div class="header">

		<div class="title">Lobby</div>
		
		<div class="subtitle">

			<div class="game">Game: Pong for Two</div>
			
			<div class="gamemode">Mode: @NetworkManager.Instance.GameMode</div>
			
		</div>


	</div>

	<div class="body">

		<div class="playerlist">

			@foreach (var player in Connection.All)
			{

				<div class="player">
					<div class="name">
						@if (Networking.IsHost)
						{
							<div>[Host]</div>
							if (player != Connection.Local)
							{
								<div class="prefix" onclick="@(() => player.Kick("You were kicked by the host"))">❌</div>
							}
						}
						@player.DisplayName
					</div>
					<div class="ping">
						<img src="\icons\signal_cellular_alt.png" style="width: 35px; margin: 0px 5px;" alt="Ping" /> @player.Ping
					</div>
				</div>
			}

			@if (Connection.All.Count < 2)
			{
				<div class="invite">Invite a friend to play in multiplayer mode!</div>
			}

		</div>

		<div class="settings">

			<div class="option">
				<label class="option_name">Lobby Privacy:</label>
				<div class="adjuster">
					<label class="option_adjust" onclick='@(() => SetLobbyPrivacy("left"))'>&#60;</label>
					<label class="option_value">@LobbyPrivacy</label>
					<label class="option_adjust" onclick='@(() => SetLobbyPrivacy("right"))'>&#62;</label>
				</div>
			</div>

			@* <div class="option">
				<label class="option_name">Max Players:</label>
				<div class="adjuster">
					<label class="option_adjust" onclick="@(() => ChangeValue("decrement", MaxPlayers, 1, 1))">&#60;</label>
					<label class="option_value">@MaxPlayers</label>
					<label class="option_adjust" onclick="@(() => ChangeValue("increment", MaxPlayers, 1, 1))">&#62;</label>
				</div>
			</div> *@

			<div class="option">
				<label class="option_name">Number of Rounds:</label>
				<div class="adjuster">
					<label class="option_adjust" onclick="@(() => { var rounds = MaxRounds; ChangeValue("decrement", ref rounds, 1, 10); MaxRounds = rounds; })">-10</label>
					<label class="option_adjust" onclick="@(() => { var rounds = MaxRounds; ChangeValue("decrement", ref rounds, 1, 1); MaxRounds = rounds; })">-1</label>
					<label class="option_value">@MaxRounds</label>
					<label class="option_adjust" onclick="@(() => { var rounds = MaxRounds; ChangeValue("increment", ref rounds, 1, 1); MaxRounds = rounds; })">+1</label>
					<label class="option_adjust" onclick="@(() => { var rounds = MaxRounds; ChangeValue("increment", ref rounds, 1, 10); MaxRounds = rounds; })">+10</label>
				</div>
			</div>

			<div class="option">
				<label class="option_name">Ball Speed:</label>
				<div class="adjuster">
					<label class="option_adjust" onclick="@(() => { var speed = Speed; ChangeValue("decrement", ref speed, 100, 100); Speed = speed; })">-100</label>
					<label class="option_adjust" onclick="@(() => { var speed = Speed; ChangeValue("decrement", ref speed, 100, 10); Speed = speed; })">-10</label>
					<label class="option_value">@Speed</label>
					<label class="option_adjust" onclick="@(() => { var speed = Speed; ChangeValue("increment", ref speed, 100, 10); Speed = speed; })">+10</label>
					<label class="option_adjust" onclick="@(() => { var speed = Speed; ChangeValue("increment", ref speed, 100, 100); Speed = speed; })">+100</label>
				</div>
			</div>

			@* <div class="option">
				<label class="option_name">Paddle Size:</label>
				<div class="adjuster">
					<label class="option_adjust">&#60;</label>
					<label class="option_value"></label>
					<label class="option_adjust">&#62;</label>
				</div>
			</div> *@

			<div class="option">
				<label class="option_name">Ball Acceleration:</label>
				<div class="adjuster">
					<label class="option_adjust" onclick=@( () => ChangeAcceleration() )>&#60;</label>
					<label class="option_value">@accelerationText</label>
					<label class="option_adjust" onclick=@( () => ChangeAcceleration() )>&#62;</label>
				</div>
			</div>

			@if (Networking.IsHost)
			{
				<div class="button reset" onclick="@(() => OnReset())">
					Reset to default
				</div>
			}
			else
			{
				<div class="button disabled">
					<label class="reset">You are not the host</label>
				</div>
			}

		</div>

	</div>

	<div class="footer">

		@if (Networking.IsHost)
		{
			<div class="button play" onclick="@(() => OnPlay())">Play</div>
		}
		else
		{
			<div class="button disabled">Waiting for the host</div>
		}

		<div class="button exit" onclick="@(() => OnLeaveLobby())">Leave</div>

	</div>
</root>

@code
{
	@* [Sync] public int MaxPlayers { get; set; } *@
	[Sync] public LobbyPrivacy LobbyPrivacy { get; set; } = LobbyPrivacy.Public;
	[Sync] public int MaxRounds { get; set; }
	[Sync] public int Speed { get; set; }
	[Sync] public bool Acceleration { get; set; }
	[Sync] public string accelerationText { get; set; }

	public LobbyMenu()
	{

		@* MaxPlayers = GameSettings.MaxPlayers; *@
		MaxRounds = GameSettings.MaxRounds;
		Speed = GameSettings.Speed;
		Acceleration = GameSettings.Acceleration;
	}

	@* void SetToTeam(Connection player)
	{
		if (!Networking.IsHost) return;

		NetworkManager.player.Team = "Player";
	} *@

	void SetLobbyPrivacy(string direction)
	{
		if (LobbyPrivacy == LobbyPrivacy.Public)
		{
			if (direction == "left")
			{
				LobbyPrivacy = LobbyPrivacy.Private;
				GameSettings.LobbyPrivacy = LobbyPrivacy;
			}
			else if (direction == "right")
			{
				LobbyPrivacy = LobbyPrivacy.FriendsOnly;
				GameSettings.LobbyPrivacy = LobbyPrivacy;
			}
		}
		else if (LobbyPrivacy == LobbyPrivacy.Private)
		{
			if (direction == "left")
			{
				LobbyPrivacy = LobbyPrivacy.FriendsOnly;
				GameSettings.LobbyPrivacy = LobbyPrivacy;
			}
			else if (direction == "right")
			{
				LobbyPrivacy = LobbyPrivacy.Public;
				GameSettings.LobbyPrivacy = LobbyPrivacy;
			}
		}
		else if (LobbyPrivacy == LobbyPrivacy.FriendsOnly)
		{
			if (direction == "left")
			{
				LobbyPrivacy = LobbyPrivacy.Public;
				GameSettings.LobbyPrivacy = LobbyPrivacy;
			}
			else if (direction == "right")
			{
				LobbyPrivacy = LobbyPrivacy.Private;
				GameSettings.LobbyPrivacy = LobbyPrivacy;
			}
		}
	}

	void ChangeValue(string operation, ref int value, int min, int step)
	{
		if (!Networking.IsHost) return;

		if (operation == "increment")
		{
			value = Math.Max(min, value + step);
		}
		else if (operation == "decrement")
		{
			value = Math.Max(min, value - step);
		}
	}

	void ChangeAcceleration()
	{
		if (Acceleration)
		{
			Acceleration = false;
		}
		else
		{
			Acceleration = true;
		}
	}

	void OnReset()
	{
		if (!Networking.IsHost) return;

		@* MaxPlayers = 4; *@
		LobbyPrivacy = LobbyPrivacy.Public;
		MaxRounds = 20;
		Speed = 400;
		Acceleration = true;
	}

	void OnPlay()
	{
		@* GameSettings.MaxPlayers = MaxPlayers; *@
		GameSettings.MaxRounds = MaxRounds;
		GameSettings.Speed = Speed;
		GameSettings.Acceleration = Acceleration;

		SceneLoadOptions load = new SceneLoadOptions();
		load.SetScene("scenes/game.scene");
		Game.ChangeScene(load);
	}

	void OnLeaveLobby()
	{
		Networking.Disconnect();
		Scene.LoadFromFile("scenes/MainMenu.scene");
	}

	protected override void OnUpdate()
	{
		GameSettings.LobbyPrivacy = LobbyPrivacy;
		GameSettings.MaxRounds = MaxRounds;
		GameSettings.Speed = Speed;
		GameSettings.Acceleration = Acceleration;
		accelerationText = Acceleration ? "Yes" : "No";
	}

	/// <summary>
	/// the hash determines if the system should be rebuilt. If it changes, it will be rebuilt
	/// </summary>

	protected override int BuildHash() => System.HashCode.Combine(
	@* MaxPlayers, *@
	LobbyPrivacy,
	NetworkManager.Instance.GameMode,
	MaxRounds,
	Speed,
	Acceleration,
	Connection.All.Count
	);
}
